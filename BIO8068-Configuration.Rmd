---
title: "BIO8068 Data Visualisaton in Ecology"
subtitle: "Initial setup and configuration"
output:
  html_document: default
  word_document:
    reference_docx: word_template.docx
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
I am hoping that all the PCs in the Nereid cluster will be pre-configured with the appropriate versions of R, RStudio and Git (a version control package). RStudio is slow on the Windows Virtual Desktop and you are not recommended to use it in this module. You can use your own PC or MacBook, but please be aware that setting up some packages may be difficult. 

You will use a large number of R packages in this module, some of which you may not have encountered before. Some R packages will need to be 'compiled' from the original source code, which creates an extra difficulty. You will also regularly use some external programmes, that will need to be installed onto your computer, although you will actually operate them through R. This first workshop is therefore a technical one, to ensure that you all have access to a properly configured computer so that you can complete the rest of the module.

**Overall recommendation** Begin by using the Nereid Windows 10 PCs. Once you are confident or have time, try using your own Windows laptop or MacBook.

# 1. Compiling R packages
To compile an R package from its source code differs between Windows and MacBooks, as Windows machines need an additional program called RTools40:

## 1.1 Compiling R packages: Nereid Windows 10 cluster
Hopefully RTools40 will already be pre-configured and ready to go.

## 1.2 Compiling R packages: your own Windows 10 laptop
You will need Administrator rights in order to install RTools40; note that depending on your setup you may have to enter a different username or password, but on most Windows PCs the username for the main admin role is Administrator.  Go to:

<https://cran.r-project.org/bin/windows/Rtools/>

It is likely that nearly all of you will be using a 64-bit version of Windows, as only fairly old PCs are 32-bit. Download the file:

<https://cran.r-project.org/bin/windows/Rtools/rtools40-x86_64.exe>

The file `rtools40-x86_64`, the `.exe` might not be displayed, will probably be saved in your Downloads folder: double-click on it to begin the installation. At this point, you might be prompted to enter your Administrator password. Now start up RStudio, and in the RStudio Console enter the following command:

```{r, eval=FALSE}
writeLines('PATH="${RTOOLS40_HOME}\\usr\\bin;${PATH}"', con = "~/.Renviron")
```

This adds the folder that contains the RTools software to your R search "environment". Finally, you need to check that RStudio has detected everything correctly:

* Close RStudio down completely
* Restart RStudio again
* In the RStudio Console enter `Sys.which("make")`

If it is configured correctly, it might display something like:

`"C:\\rtools40\\usr\\bin\\make.exe"`

in response. However, don't panic if it displays `""` in response. The real test is whether it can install an R package from source. In the RStudio Console try entering:

```{r, eval=FALSE}
install.packages("jsonlite", type = "source")
```

You should see lots of information printed to screen as it installs the package. It takes a little longer than the default method of `type = "binary"` that you are used to using.

## 1.3 Compiling R packages: MacBooks
This should already have all the additional software already installed for you.

# 2. Reproducible research; version control with `git` and GitHub
You will be learning about the concepts of reproducible research in this module, which is of increasing importance in ecology, as scientists want to make both their data and analytical methods available for others to use. This involves two components:

* GitHub - This is a website <github.com> onto which you can register for free. It will allow you to store copies of your data and analyses, and share with other users and machines. We will spend time in a separate practical explaining how to register and use this website.
* `git` - this is the program that does the hard work of keeping track of different versions of code and data. It is installed on your local PC or MacBook.

## 2.1 Installing git
If you find that you do not have `git` installed, you can access the main downloads page at <https://git-scm.com/downloads> which will display

![](images/git_downloads.png)


### 2.2.1 Installing git in Neried Windows 10 cluster
Several weeks prior to this module beginning I placed a support ticket with NUIT to install the git client in the Neried cluster, so hopefully nothing needs to be done.

### 2.2.2 Installing git on a personal Windows 10 laptop
It is unlikely that you will already have `git` installed on Windows. If you want to check, start RStudio, then click on the "Terminal" tab, next to the RStudio Console tab at the bottom left. Try typing `git which` and hit the Enter key, followed by `git --version`; if you are lucky it will report that `git` is installed, and its version number. You are more likely to have to download and install the program. Go to the main git downloads page (above) and click the "Windows" option. The downloader should automatically detect which version of Windows you are using, and download the best version. It will probably again be saved into your Downloads folder. Double-click on it to install; again you will probably have to enter your Administrator password. Two key points for the installation process:

* When asked about “Adjusting your PATH environment”, make sure to select “Git from the command line and also from 3rd-party software”. Otherwise, accept the defaults.
* Note that RStudio for Windows prefers for Git to be installed below `C:/Program Files` and this appears to be the default. This implies, for example, that the Git executable on most Windows system is found at `C:/Program Files/Git/bin/git.exe`. My own laptop is managed by NUIT, so ironically, git is not in this location, but still works OK.


### 2.2.3 git on MacOS
If you are using a MacBook, `git` **should already be pre-installed**. You can check by click on the Launchpad button and opening a terminal:

![](images/click_launchpad.png)

and then type Terminal:

![](images/terminal_from_launchpad.png)

The Terminal app should open in its own window. Type `which git` and hit the Enter key, and it should report something like `/usr/local/bin/git`. You can then check its version with `git --version`. I would also recommend that you do some general searches on your MacBook to see if you can find git anywhere. In the unlikely event that it is not installed, you will need to install it separately. You may have a software installation system already configured for your MacBook, in which case use that to install git. Alternatively, use the Xcode developer tools available via the main git downloads page (above) or from the official Apple website <https://developer.apple.com/xcode/>. The actual download link is near the bottom of the webpage. **Note** You might already have Xcode installed! After you have installed Xcode, open up your Terminal window and enter:

```{r, eval=FALSE}
git --version
git config
```

Accept the offer and click on "Install" and everything should get configured.

Sometimes MacOS displays the error  "xcrun: error: invalid active developer path (/Library/Developer/CommandLineTools), missing xcrun at: /Library/Developer/CommandLineTools/usr/bin/xcrun". Follow the instructions from the top rated comment on this link and it should fix the error: <https://stackoverflow.com/questions/52522565/git-is-not-working-after-macos-update-xcrun-error-invalid-active-developer-pa>


## 2.3 Configuring git before use
Before you can use `git` it needs to have a basic configuration, so it knows who you are. You can do this now, or during the relevant practical, where we cover this material again. In RStudio, start the RStudio Terminal window (**not** the RStudio Console) and type:

```{r, eval=FALSE}
git config --global user.name 'John Smith'
git config --global user.email 'j.smith123@newcastle.ac.uk'
git config --global --list
```

subsituting your real name (not your login number) and Newcastle University email address instead of `John Smith` and `j.smith123`.


# 3. Python, Keras and Tensorflow
You will use a couple of R packages that access external packages written in Python. This is a very similar language to R, and popular for data analytics, deep learning and artificial intelligence. You do not need to have an understanding of how Python works to use the relevant R packages, but you will need a working version of Python. We will use an R package called `keras` which calls external Python packages (Keras and Tensorflow). Most Windows PCs do not come with Python pre-installed, whereas most MacBooks have it automatically.

## 3.1 Keras installation: Neried Cluster and personal Windows 10 laptops
Configuration can be a little tricky, especially as we do not have administrator rights for the Nereid Cluster. I have therefore created an R script called `keras_setup.R` (available on Canvas). Please open this in RStudio, and process it line-by-line, checking for errors, and it should configure the software for you.


### 3.2 Keras installation: MacOS
Python should be pre-installed on MacOS, but you will need to check that you have recent versions. Open up a MacOS Terminal window (see above) and enter `python --version` and `python3 --version`. It should confirm that you have both Python 2 and Python 3 available. In the unlikely event that it is missing, go to <https://www.python.org/downloads/release/python-392/> to download the most recent Python 3 version for MacOS. See also comment in section 3.3 below about MacOS Big Sur.

Start-up RStudio and in the command line type the following lines. **Note** If at any point you receive a message along the lines "Do you want to install Miniconda" then answer Yes. Miniconda is a stripped-down minimal version of Python that works with R.

```{r, eval=FALSE}
install.packages("keras")
library(keras)
```

If this works OK, the next step is to install the connections to Python:

```{r, eval=FALSE}
install_keras()
```

The `install_keras()` function may take a while to run, as it installs additional Python and R packages. Finally, check that it can work, by seeing if it can load one of its built-in datasets; This is auto-downloaded from Google, and uncompressed via Tensorflow Python:

```{r, eval=FALSE}
mydata <- dataset_mnist()
summary(mydata)
```

## 3.3 Troubleshooting Keras installation on MacOS
A common area that can go wrong is with the Tensorflow Python libraries that Keras uses. If you are using a MacOS computer with High Sierra then it should be possible to install Keras successfully. If you have the most recent MacOS Big Sur update, there are reported problems with Tensorflow. First try in a Terminal window typing:

`pip3 install tensorflow`

The official MacOS installation guidelines are at <https://github.com/apple/tensorflow_macos>. Within RStudio try and install the R `reticulate` separately, then conda:

`install.packages("reticulate")`
`library(reticulate)`
`conda_list() # Does R detect any Python environments?`
`conda_install("r-reticulate") # Installs a Python virtual environment` 

If you receive errors in the `conda_install()` step, you may have to clean up a faulty Miniconda installation. In the Terminal window `conda clean --all` should do this. If using Windows you might receive a message that `conda cannot be found`. We can help troubleshoot this message.




# 4. R packages for Citizen Science wildlife databases
You will make use of several Citizen Science databases, in particular the Global Biodiversity Information Facility (GBIF), iNaturalist and National Biodiversity Network Atlas sites. These have R packages to access them, but the latter is in development, and not available on CRAN in the usual manner. Check that they install successfully:

```{r, eval=FALSE}
# On CRAN, usually no problems
install.packages("rgbif")
install.packages("rinat") 
```

NBN4R can be trickier:

```{r, eval=FALSE}
install.packages("devtools")
library(devtools)
install_github("fozy81/NBN4R")
```

If you receive an error for an individual package, you may have to install it manually, e.g. if it gives errors for `stringr` and `sp` then try:

```{r, eval=FALSE}
install.packages(c("stringr","sp"))
install_github("fozy81/NBN4R")
```


# 5. R packages for wildlife acoustics
A large number of packages are available for acoustics data. In this module we will use the `behaviouR` package, which has the advantage of a good, online website book, and lots of useful functions that call the other packages, and make data-processing more accessible for ecologists. The main disadvantage is that it is not on CRAN, so might stumble. It also installs a lot of other packages in the background, any one of which may need checking:

```{r, eval=FALSE}
# Install 'behaviouR' package from Gitub
devtools::install_github("https://github.com/DenaJGibbon/behaviouR")
```

# 6. R packages for website development
You will develop an interactive "decision support system" for environmental management as part of this project, using an R package called `shiny` <https://shiny.rstudio.com/> which converts conventional R code into hyper-text markup language (HTML) so that you can create interactive web-pages. We need to check that you can install `shiny` and generate the default application:

```{r, eval=FALSE}
install.packages("shiny")
library(shiny)
```

Once you have installed it, in RStudio click on **File -> New File -> Shiny Web App...** Give the file whatever name you want. This will create a default application that should display a histogram of the frequency with which the "Old Faithful" hot water geyser in the USA sends a jet of water into the air, with sliders to change the appearance of the histogram. Check you can run the app, and that the histogram is displayed.

# 7. BIRDS Biodiversity Information Review & Decision Support
The BIRDS package helps assess changes in time and space with Citizen Science databases, and also evaluate its quality. You should be able to install it directly from CRAN, but it also uses quite a lot of packages in the background:

```{r, eval=FALSE}
install.packages("BIRDS")
```

# 8. Miscellaneous R packages
There are a lot of R packages used in this module, and I will admit that I am not 100% sure which ones are automatically installed, which you have already installed in previous modules such as BIO8069 or NES8010, and which are optional. Extra packages to consider include (I may have forgotten some!):

```{r, eval=FALSE}
library(ggplot2)
library(dplyr)
library(lubridate)
library(warbleR)
library(sp)
library(sf)
library(raster)
library(mapview)
library(leaflet)
library(leafem)
library(xts)
library(zoo)
library(shinipsum) # optional
library(camtrapR)  # optional
library(imager)    # optional
```

If you get messages saying that R cannot find the package then we may have to download from source, although as all of these packages are on CRAN so can be installed in the normal manner. If any of them fail to install then please consult myself or one of the PGR demonstrators.
